{"version":3,"sources":["../../src/actions/mark-prs.js"],"names":["markForClosure","client","context","args","pr","issues","addLabels","repo","issue_number","number","labels","map","l","name","closingSoonLabel","createComment","body","closingSoonComment","replace","autoCloseAfterWarnSecs","opts","prs","logger","toMark","p","autoCloseLabel","warnClosingAfterSecs","processedPrNumbers","debug","push","info","length"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA,MAAMA,cAAc,GAAG,OAAO;AAAEC,EAAAA,MAAF;AAAUC,EAAAA,OAAV;AAAmBC,EAAAA;AAAnB,CAAP,EAAkCC,EAAlC,KAAyC;AAC9D,QAAMH,MAAM,CAACI,MAAP,CAAcC,SAAd,CAAwB,EAC5B,GAAGJ,OAAO,CAACK,IADiB;AAE5BC,IAAAA,YAAY,EAAEJ,EAAE,CAACK,MAFW;AAG5BC,IAAAA,MAAM,EAAE,CAAC,GAAGN,EAAE,CAACM,MAAH,CAAUC,GAAV,CAAcC,CAAC,IAAIA,CAAC,CAACC,IAArB,CAAJ,EAAgCV,IAAI,CAACW,gBAArC;AAHoB,GAAxB,CAAN;AAKA,QAAMb,MAAM,CAACI,MAAP,CAAcU,aAAd,CAA4B,EAChC,GAAGb,OAAO,CAACK,IADqB;AAEhCC,IAAAA,YAAY,EAAEJ,EAAE,CAACK,MAFe;AAGhCO,IAAAA,IAAI,EAAEb,IAAI,CAACc,kBAAL,CAAwBC,OAAxB,CAAgC,cAAhC,EAAgD,yBAAYf,IAAI,CAACgB,sBAAjB,CAAhD;AAH0B,GAA5B,CAAN;AAKD,CAXD;;eAaeC,IAAI,IAAI,MAAMC,GAAN,IAAa;AAClC,QAAM;AAAElB,IAAAA,IAAF;AAAQmB,IAAAA;AAAR,MAAmBF,IAAzB;AACA,QAAMG,MAAM,GAAG,qBACbF,GADa,EAEbG,CAAC,IACCA,CAAC,CAACd,MAAF,IACA,sBAASc,CAAT,EAAYrB,IAAI,CAACsB,cAAjB,CADA,IAEA,CAAC,sBAASD,CAAT,EAAYrB,IAAI,CAACW,gBAAjB,CAFD,IAGA,CAAC,kCAAqBU,CAArB,EAAwBrB,IAAI,CAACuB,oBAA7B,CANU,CAAf;AASA,QAAMC,kBAAkB,GAAG,EAA3B;;AACA,aAAW,IAAIvB,EAAf,IAAqBmB,MAArB,EAA6B;AAC3BD,IAAAA,MAAM,CAACM,KAAP,CAAc,cAAa,wBAAWxB,EAAX,CAAe,cAA1C;AACA,UAAMJ,cAAc,CAACoB,IAAD,EAAOhB,EAAP,CAApB;AACAuB,IAAAA,kBAAkB,CAACE,IAAnB,CAAwBzB,EAAE,CAACK,MAA3B;AACD;;AACDa,EAAAA,MAAM,CAACQ,IAAP,CAAa,UAASH,kBAAkB,CAACI,MAAO,kBAAhD;AACA,SAAOJ,kBAAP;AACD,C","sourcesContent":["import filter from '@async-generators/filter';\r\nimport { hasLabel, updatedInTheLastSecs, nowPlusSecs, describePr } from '../common';\r\n\r\nconst markForClosure = async ({ client, context, args }, pr) => {\r\n  await client.issues.addLabels({\r\n    ...context.repo,\r\n    issue_number: pr.number,\r\n    labels: [...pr.labels.map(l => l.name), args.closingSoonLabel],\r\n  });\r\n  await client.issues.createComment({\r\n    ...context.repo,\r\n    issue_number: pr.number,\r\n    body: args.closingSoonComment.replace(/\\@closeTime/g, nowPlusSecs(args.autoCloseAfterWarnSecs)),\r\n  });\r\n};\r\n\r\nexport default opts => async prs => {\r\n  const { args, logger } = opts;\r\n  const toMark = filter(\r\n    prs,\r\n    p =>\r\n      p.labels &&\r\n      hasLabel(p, args.autoCloseLabel) &&\r\n      !hasLabel(p, args.closingSoonLabel) &&\r\n      !updatedInTheLastSecs(p, args.warnClosingAfterSecs),\r\n  );\r\n\r\n  const processedPrNumbers = [];\r\n  for await (let pr of toMark) {\r\n    logger.debug(`Marking PR ${describePr(pr)} for closure`);\r\n    await markForClosure(opts, pr);\r\n    processedPrNumbers.push(pr.number);\r\n  }\r\n  logger.info(`Marked ${processedPrNumbers.length} PRs for closure`);\r\n  return processedPrNumbers;\r\n};\r\n"],"file":"mark-prs.js"}