{"version":3,"sources":["../../src/actions/close-prs.js"],"names":["opts","prs","args","logger","prsToClose","p","autoCloseLabel","closingSoonLabel","processedPrNumbers","pr","latestCommentAge","number","autoCloseAfterWarnSecs","info","closePr","push","length","client","context","pulls","update","repo","pull_number","state","deleteOnClose"],"mappings":";;;;;;;AAAA;;AACA;;;;eAEeA,IAAI,IAAI,MAAMC,GAAN,IAAa;AAClC,QAAM;AAAEC,IAAAA,IAAF;AAAQC,IAAAA;AAAR,MAAmBH,IAAzB;AAEA,QAAMI,UAAU,GAAG,qBACjBH,GADiB,EAEjBI,CAAC,IAAI,sBAASA,CAAT,EAAYH,IAAI,CAACI,cAAjB,KAAoC,sBAASD,CAAT,EAAYH,IAAI,CAACK,gBAAjB,CAFxB,CAAnB;AAKA,QAAMC,kBAAkB,GAAG,EAA3B;;AACA,aAAW,IAAIC,EAAf,IAAqBL,UAArB,EAAiC;AAC/B,UAAMM,gBAAgB,GAAG,MAAM,4CAA+BV,IAA/B,EAAqCS,EAAE,CAACE,MAAxC,CAA/B;;AACA,QAAID,gBAAgB,IAAI,IAApB,IAA4BA,gBAAgB,GAAGR,IAAI,CAACU,sBAAxD,EAAgF;AAC9ET,MAAAA,MAAM,CAACU,IAAP,CAAa,WAAU,wBAAWJ,EAAX,CAAe,EAAtC;AACA,YAAMK,OAAO,CAACd,IAAD,EAAOS,EAAP,CAAb;AACAD,MAAAA,kBAAkB,CAACO,IAAnB,CAAwBN,EAAE,CAACE,MAA3B;AACD;AACF;;AACDR,EAAAA,MAAM,CAACU,IAAP,CAAa,UAASL,kBAAkB,CAACQ,MAAO,MAAhD;AACA,SAAOR,kBAAP;AACD,C;;;;AAED,MAAMM,OAAO,GAAG,OAAOd,IAAP,EAAaK,CAAb,KAAmB;AACjC,QAAM;AAACY,IAAAA,MAAD;AAASC,IAAAA,OAAT;AAAkBhB,IAAAA;AAAlB,MAA0BF,IAAhC;AACA,QAAMiB,MAAM,CAACE,KAAP,CAAaC,MAAb,CAAoB,EACxB,GAAGF,OAAO,CAACG,IADa;AAExBC,IAAAA,WAAW,EAAEjB,CAAC,CAACM,MAFS;AAGxBY,IAAAA,KAAK,EAAE;AAHiB,GAApB,CAAN;;AAKA,MAAIrB,IAAI,CAACsB,aAAT,EAAwB;AACtB,UAAM,4BAAexB,IAAf,EAAqBK,CAArB,CAAN;AACD;AACF,CAVD","sourcesContent":["import filter from '@async-generators/filter';\r\nimport { hasLabel, describePr, getLatestClosingCommentAgeSecs, deletePrBranch } from '../common';\r\n\r\nexport default opts => async prs => {\r\n  const { args, logger } = opts;\r\n\r\n  const prsToClose = filter(\r\n    prs,\r\n    p => hasLabel(p, args.autoCloseLabel) && hasLabel(p, args.closingSoonLabel),\r\n  );\r\n\r\n  const processedPrNumbers = [];\r\n  for await (let pr of prsToClose) {\r\n    const latestCommentAge = await getLatestClosingCommentAgeSecs(opts, pr.number);\r\n    if (latestCommentAge != null && latestCommentAge > args.autoCloseAfterWarnSecs) {\r\n      logger.info(`Closing ${describePr(pr)}`);\r\n      await closePr(opts, pr);\r\n      processedPrNumbers.push(pr.number);\r\n    }\r\n  }\r\n  logger.info(`Closed ${processedPrNumbers.length} PRs`);\r\n  return processedPrNumbers;\r\n};\r\n\r\nconst closePr = async (opts, p) => {\r\n  const {client, context, args} = opts;\r\n  await client.pulls.update({\r\n    ...context.repo,\r\n    pull_number: p.number,\r\n    state: 'closed',\r\n  });\r\n  if (args.deleteOnClose) {\r\n    await deletePrBranch(opts, p);\r\n  }\r\n};\r\n"],"file":"close-prs.js"}