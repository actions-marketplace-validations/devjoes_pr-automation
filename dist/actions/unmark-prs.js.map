{"version":3,"sources":["../../src/actions/unmark-prs.js"],"names":["unMarkForClosure","opts","pr","context","client","args","issues","removeLabel","repo","issue_number","number","name","closingSoonLabel","deleteComments","issueNumber","comments","listComments","data","filter","c","body","indexOf","closingSoonComment","replace","forEach","deleteComment","comment_id","id","prs","logger","filtered","p","labels","autoCloseLabel","warnClosingAfterSecs","processedPrNumbers","oldestComment","debug","push","info","length"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA,MAAMA,gBAAgB,GAAG,OAAOC,IAAP,EAAaC,EAAb,KAAoB;AAC3C,QAAM;AAAEC,IAAAA,OAAF;AAAWC,IAAAA,MAAX;AAAmBC,IAAAA;AAAnB,MAA4BJ,IAAlC;AACA,QAAMG,MAAM,CAACE,MAAP,CAAcC,WAAd,CAA0B,EAC9B,GAAGJ,OAAO,CAACK,IADmB;AAE9BC,IAAAA,YAAY,EAAEP,EAAE,CAACQ,MAFa;AAG9BC,IAAAA,IAAI,EAAEN,IAAI,CAACO;AAHmB,GAA1B,CAAN;AAKA,QAAMC,cAAc,CAACZ,IAAD,EAAOC,EAAE,CAACQ,MAAV,CAApB;AACD,CARD;;AASA,MAAMG,cAAc,GAAG,OAAO;AAAET,EAAAA,MAAF;AAAUD,EAAAA,OAAV;AAAmBE,EAAAA;AAAnB,CAAP,EAAkCS,WAAlC,KAAkD;AACvE,QAAMC,QAAQ,GAAG,CACf,MAAMX,MAAM,CAACE,MAAP,CAAcU,YAAd,CAA2B,EAC/B,GAAGb,OAAO,CAACK,IADoB;AAE/BC,IAAAA,YAAY,EAAEK;AAFiB,GAA3B,CADS,EAKfG,IALe,CAKVC,MALU,CAKHC,CAAC,IAAIA,CAAC,CAACC,IAAF,CAAOC,OAAP,CAAehB,IAAI,CAACiB,kBAAL,CAAwBC,OAAxB,CAAgC,MAAhC,EAAwC,EAAxC,CAAf,MAAgE,CALlE,CAAjB;AAOA,QAAMR,QAAQ,CAACS,OAAT,CAAiB,MAAML,CAAN,IAAW;AAChC,UAAMf,MAAM,CAACE,MAAP,CAAcmB,aAAd,CAA4B,EAChC,GAAGtB,OAAO,CAACK,IADqB;AAEhCkB,MAAAA,UAAU,EAAEP,CAAC,CAACQ;AAFkB,KAA5B,CAAN;AAID,GALK,CAAN;AAMD,CAdD;;eAgBe1B,IAAI,IAAI,MAAM2B,GAAN,IAAa;AAClC,QAAM;AAAEC,IAAAA;AAAF,MAAa5B,IAAnB;AACA,QAAM6B,QAAQ,GAAG,qBACfF,GADe,EAEfG,CAAC,IACCA,CAAC,CAACC,MAAF,IACA,sBAASD,CAAT,EAAY9B,IAAI,CAACI,IAAL,CAAU4B,cAAtB,CADA,IAEA,sBAASF,CAAT,EAAY9B,IAAI,CAACI,IAAL,CAAUO,gBAAtB,CAFA,IAGA,kCAAqBmB,CAArB,EAAwB9B,IAAI,CAACI,IAAL,CAAU6B,oBAAlC,CANa,CAAjB;AAQA,QAAMC,kBAAkB,GAAG,EAA3B;;AACA,aAAW,IAAIjC,EAAf,IAAqB4B,QAArB,EAA+B;AAC7B,UAAMM,aAAa,GAAG,OAAM,4CAA+BnC,IAA/B,EAAqCC,EAAE,CAACQ,MAAxC,CAAN,KAAyDT,IAAI,CAACI,IAAL,CAAU6B,oBAAzF;;AACA,QAAIE,aAAa,IAAInC,IAAI,CAACI,IAAL,CAAU6B,oBAA/B,EAAqD;AACnDL,MAAAA,MAAM,CAACQ,KAAP,CAAc,eAAc,wBAAWnC,EAAX,CAAe,cAA3C;AACA,YAAMF,gBAAgB,CAACC,IAAD,EAAOC,EAAP,CAAtB;AACAiC,MAAAA,kBAAkB,CAACG,IAAnB,CAAwBpC,EAAE,CAACQ,MAA3B;AACD;AACF;;AACDmB,EAAAA,MAAM,CAACU,IAAP,CAAa,YAAWJ,kBAAkB,CAACK,MAAO,kBAAlD;AACA,SAAOL,kBAAP;AACD,C","sourcesContent":["import filter from '@async-generators/filter';\r\nimport { hasLabel, updatedInTheLastSecs, getLatestClosingCommentAgeSecs, describePr } from '../common';\r\n\r\nconst unMarkForClosure = async (opts, pr) => {\r\n  const { context, client, args } = opts;\r\n  await client.issues.removeLabel({\r\n    ...context.repo,\r\n    issue_number: pr.number,\r\n    name: args.closingSoonLabel,\r\n  });\r\n  await deleteComments(opts, pr.number);\r\n};\r\nconst deleteComments = async ({ client, context, args }, issueNumber) => {\r\n  const comments = (\r\n    await client.issues.listComments({\r\n      ...context.repo,\r\n      issue_number: issueNumber,\r\n    })\r\n  ).data.filter(c => c.body.indexOf(args.closingSoonComment.replace(/\\@.*/, '')) === 0);\r\n\r\n  await comments.forEach(async c => {\r\n    await client.issues.deleteComment({\r\n      ...context.repo,\r\n      comment_id: c.id,\r\n    });\r\n  });\r\n};\r\n\r\nexport default opts => async prs => {\r\n  const { logger } = opts;\r\n  const filtered = filter(\r\n    prs,\r\n    p =>\r\n      p.labels &&\r\n      hasLabel(p, opts.args.autoCloseLabel) &&\r\n      hasLabel(p, opts.args.closingSoonLabel) &&\r\n      updatedInTheLastSecs(p, opts.args.warnClosingAfterSecs),\r\n  );\r\n  const processedPrNumbers = [];\r\n  for await (let pr of filtered) {\r\n    const oldestComment = await getLatestClosingCommentAgeSecs(opts, pr.number) || opts.args.warnClosingAfterSecs;\r\n    if (oldestComment >= opts.args.warnClosingAfterSecs) {\r\n      logger.debug(`Unmarked PR ${describePr(pr)} for closure`);\r\n      await unMarkForClosure(opts, pr);\r\n      processedPrNumbers.push(pr.number);\r\n    }\r\n  }\r\n  logger.info(`Unmarked ${processedPrNumbers.length} PRs for closure`);\r\n  return processedPrNumbers;\r\n};\r\n"],"file":"unmark-prs.js"}